apiVersion: canaries.flanksource.com/v1
kind: Canary
metadata:
  name: base-image-selftest
spec:
  schedule: "@every 5m"
  exec:
    - name: shell
      description: "Shell script execution"
      script: echo "hello-world"
      display:
        expr: 'results.stderr + results.stdout'
      test:
        expr: 'results.stdout == "hello-world"'

    - name: env
      description: "Environment variable handling"
      script: echo -n "${TEST_VAR}"
      env:
        - name: TEST_VAR
          value: "env-test-passed"
      display:
        expr: 'results.stderr + results.stdout'
      test:
        expr: 'results.stdout == "env-test-passed"'

    - name: curl
      description: "curl is available"
      script: curl --version | head -1
      display:
        expr: 'results.stderr + results.stdout'
      test:
        expr: 'results.stdout.contains("curl")'

    - name: jq
      description: "jq is available"
      script: echo '{"test":"value"}' | jq -r '.test'
      display:
        expr: 'results.stderr + results.stdout'
      test:
        expr: 'results.stdout == "value"'

    - name: git
      description: "git is available"
      script: git --version
      display:
        expr: 'results.stderr + results.stdout'
      test:
        expr: 'results.stdout.contains("git version")'

    - name: kubectl
      description: "kubectl is available"
      script: kubectl version --client -o yaml | head -1
      display:
        expr: 'results.stderr + results.stdout'
      test:
        expr: 'results.exitCode == 0'

    - name: helm
      description: "helm is available"
      script: helm version --short
      display:
        expr: 'results.stderr + results.stdout'
      test:
        expr: 'results.exitCode == 0'

    - name: aws
      description: "AWS CLI is available"
      script: aws --version
      display:
        expr: 'results.stderr + results.stdout'
      test:
        expr: 'results.stdout.contains("aws-cli")'

    - name: python
      description: "Python is available"
      script: python3 --version
      display:
        expr: 'results.stderr + results.stdout'
      test:
        expr: 'results.stdout.contains("Python")'

    - name: uv
      description: "uv is available"
      script: uv --version
      display:
        expr: 'results.stderr + results.stdout'
      test:
        expr: 'results.stdout.contains("uv")'

    - name: bun
      description: "bun is available"
      script: bun --version
      display:
        expr: 'results.stderr + results.stdout'
      test:
        expr: 'results.exitCode == 0'

    - name: pwsh
      description: "PowerShell is available"
      script: pwsh --version
      display:
        expr: 'results.stderr + results.stdout'
      test:
        expr: 'results.stdout.contains("PowerShell")'

    - name: az
      description: "Azure CLI is available"
      script: az --version | head -1
      display:
        expr: 'results.stderr + results.stdout'
      test:
        expr: 'results.stdout.contains("azure-cli")'

    - name: gcloud
      description: "Google Cloud CLI is available"
      script: gcloud --version | head -1
      display:
        expr: 'results.stderr + results.stdout'
      test:
        expr: 'results.stdout.contains("Google Cloud SDK")'

    - name: yq
      description: "yq is available"
      script: yq --version
      display:
        expr: 'results.stderr + results.stdout'
      test:
        expr: 'results.exitCode == 0'

    - name: sops
      description: "sops is available"
      script: sops --version
      display:
        expr: 'results.stderr + results.stdout'
      test:
        expr: 'results.exitCode == 0'

    - name: stern
      description: "stern is available"
      script: stern --version
      display:
        expr: 'results.stderr + results.stdout'
      test:
        expr: 'results.exitCode == 0'

    - name: flux
      description: "flux is available"
      script: flux --version
      display:
        expr: 'results.stderr + results.stdout'
      test:
        expr: 'results.exitCode == 0'

    - name: fblog
      description: "fblog is available"
      script: fblog --version
      display:
        expr: 'results.stderr + results.stdout'
      test:
        expr: 'results.exitCode == 0'
